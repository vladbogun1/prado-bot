<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prado Story Graph Editor</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #0b0d12;
      --panel: #141823;
      --panel-2: #1c2233;
      --accent: #6f9dff;
      --accent-2: #3bd1c2;
      --text: #e6ebff;
      --muted: #8c96b3;
      --danger: #ff6b6b;
      --node: #1a1f2d;
      --node-border: #2d3651;
      --node-active: #3553d1;
      font-family: "Inter", "Segoe UI", system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr 320px;
    }

    header {
      grid-column: 1 / -1;
      background: linear-gradient(90deg, #121624, #151a2b);
      padding: 16px 24px;
      border-bottom: 1px solid #1e2436;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 18px;
      margin: 0;
      letter-spacing: 0.4px;
    }

    header .actions button {
      margin-left: 10px;
    }

    .sidebar,
    .inspector {
      background: var(--panel);
      padding: 18px;
      overflow-y: auto;
    }

    .sidebar {
      border-right: 1px solid #1e2436;
    }

    .inspector {
      border-left: 1px solid #1e2436;
    }

    .section-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .node-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .node-list button {
      background: var(--panel-2);
      border: 1px solid #25304a;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 8px;
      text-align: left;
      cursor: pointer;
    }

    .node-list button.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(111, 157, 255, 0.3);
    }

    .canvas {
      position: relative;
      overflow: hidden;
      background: radial-gradient(circle at 30% 20%, #101727 0%, #0b0d12 60%);
    }

    .canvas-grid {
      position: absolute;
      inset: 0;
      background-image: linear-gradient(#151b2b 1px, transparent 1px),
        linear-gradient(90deg, #151b2b 1px, transparent 1px);
      background-size: 40px 40px;
      opacity: 0.4;
      pointer-events: none;
    }

    .node {
      position: absolute;
      width: 240px;
      background: var(--node);
      border: 1px solid var(--node-border);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      cursor: grab;
    }

    .node-header {
      padding: 10px 12px;
      border-bottom: 1px solid #232b40;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
    }

    .node-header span {
      font-size: 13px;
      color: var(--accent);
    }

    .node-body {
      padding: 12px;
      font-size: 12px;
      color: var(--muted);
      display: grid;
      gap: 10px;
    }

    .socket {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text);
    }

    .socket .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--accent);
    }

    .socket.output .dot {
      background: var(--accent-2);
    }

    .inspector label {
      display: block;
      margin-bottom: 6px;
      font-size: 12px;
      color: var(--muted);
    }

    .inspector input,
    .inspector textarea,
    .inspector select {
      width: 100%;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #263049;
      background: #111625;
      color: var(--text);
      padding: 8px 10px;
      font-size: 13px;
    }

    .inspector textarea {
      min-height: 120px;
      resize: vertical;
    }

    button.primary {
      background: var(--accent);
      border: none;
      color: #0b0d12;
      padding: 8px 12px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }

    button.ghost {
      background: transparent;
      border: 1px solid #2a3350;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
    }

    .badge {
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 11px;
      background: #25304a;
      color: var(--muted);
    }

    svg.connections {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
  </style>
</head>
<body>
<header>
  <h1>Prado Story Graph Editor</h1>
  <div class="actions">
    <button class="ghost" id="exportBtn">Экспорт JSON</button>
    <button class="primary" id="addNodeBtn">Новый узел</button>
  </div>
</header>
<aside class="sidebar">
  <div class="section-title">Узлы сюжета</div>
  <div class="node-list" id="nodeList"></div>
</aside>
<main class="canvas" id="canvas">
  <div class="canvas-grid"></div>
  <svg class="connections" id="connections"></svg>
</main>
<aside class="inspector" id="inspector">
  <div class="section-title">Параметры узла</div>
  <label>Название</label>
  <input type="text" id="nodeTitle" />
  <label>Текст (variants)</label>
  <textarea id="nodeVariants"></textarea>
  <label>Тип терминала</label>
  <select id="nodeTerminal">
    <option value="NONE">NONE</option>
    <option value="SUCCESS">SUCCESS</option>
    <option value="FAIL">FAIL</option>
    <option value="DEAD">DEAD</option>
  </select>
  <label>Авто-эффекты (JSON)</label>
  <textarea id="nodeAuto"></textarea>
  <label>Награда (JSON)</label>
  <textarea id="nodeReward"></textarea>
  <div class="section-title">Выборы</div>
  <div id="choiceList"></div>
  <button class="ghost" id="addChoiceBtn">Добавить выбор</button>
</aside>

<script>
  const state = {
    nodes: [],
    links: [],
    selectedNodeId: null,
    drag: null,
  };

  const canvas = document.getElementById('canvas');
  const connections = document.getElementById('connections');
  const nodeList = document.getElementById('nodeList');
  const inspector = {
    title: document.getElementById('nodeTitle'),
    variants: document.getElementById('nodeVariants'),
    terminal: document.getElementById('nodeTerminal'),
    auto: document.getElementById('nodeAuto'),
    reward: document.getElementById('nodeReward'),
    choices: document.getElementById('choiceList'),
  };

  function createNode(payload = {}) {
    const id = `N${Date.now().toString(36)}${Math.floor(Math.random() * 100)}`;
    const node = {
      id,
      title: payload.title || 'Новый узел',
      variants: payload.variants || '"Текст узла"',
      terminalType: payload.terminalType || 'NONE',
      auto: payload.auto || '{}',
      reward: payload.reward || '{}',
      x: payload.x || 200 + state.nodes.length * 40,
      y: payload.y || 160 + state.nodes.length * 30,
      choices: payload.choices || [],
    };
    state.nodes.push(node);
    selectNode(node.id);
    render();
  }

  function addChoice(node) {
    node.choices.push({
      id: `C${Date.now().toString(36)}`,
      label: 'Новый выбор',
      successNode: '',
      failNode: '',
      effects: '[]',
    });
    renderInspector();
    render();
  }

  function selectNode(id) {
    state.selectedNodeId = id;
    render();
  }

  function render() {
    renderNodeList();
    renderNodes();
    renderConnections();
    renderInspector();
  }

  function renderNodeList() {
    nodeList.innerHTML = '';
    state.nodes.forEach(node => {
      const btn = document.createElement('button');
      btn.textContent = node.title;
      if (node.id === state.selectedNodeId) {
        btn.classList.add('active');
      }
      btn.onclick = () => selectNode(node.id);
      nodeList.appendChild(btn);
    });
  }

  function renderNodes() {
    canvas.querySelectorAll('.node').forEach(node => node.remove());
    state.nodes.forEach(node => {
      const el = document.createElement('div');
      el.className = 'node';
      el.style.left = `${node.x}px`;
      el.style.top = `${node.y}px`;
      if (node.id === state.selectedNodeId) {
        el.style.borderColor = 'var(--node-active)';
      }
      el.innerHTML = `
        <div class="node-header">
          <div>${node.title}</div>
          <span class="badge">${node.terminalType}</span>
        </div>
        <div class="node-body">
          <div>${node.variants.slice(0, 80)}</div>
          <div class="socket input"><div class="dot"></div>Вход</div>
          <div class="socket output"><div class="dot"></div>Выходы (${node.choices.length})</div>
        </div>
      `;
      el.onmousedown = (event) => {
        state.drag = { id: node.id, offsetX: event.offsetX, offsetY: event.offsetY };
      };
      el.onclick = () => selectNode(node.id);
      canvas.appendChild(el);
    });
  }

  function renderInspector() {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) {
      inspector.title.value = '';
      inspector.variants.value = '';
      inspector.terminal.value = 'NONE';
      inspector.auto.value = '';
      inspector.reward.value = '';
      inspector.choices.innerHTML = '<div class="badge">Выберите узел</div>';
      return;
    }
    inspector.title.value = node.title;
    inspector.variants.value = node.variants;
    inspector.terminal.value = node.terminalType;
    inspector.auto.value = node.auto;
    inspector.reward.value = node.reward;

    inspector.choices.innerHTML = '';
    node.choices.forEach(choice => {
      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '12px';
      wrapper.innerHTML = `
        <label>Label</label>
        <input value="${choice.label}" data-choice-id="${choice.id}" data-field="label" />
        <label>Success node</label>
        <input value="${choice.successNode}" data-choice-id="${choice.id}" data-field="successNode" />
        <label>Fail node</label>
        <input value="${choice.failNode}" data-choice-id="${choice.id}" data-field="failNode" />
        <label>Effects JSON</label>
        <textarea data-choice-id="${choice.id}" data-field="effects">${choice.effects}</textarea>
      `;
      inspector.choices.appendChild(wrapper);
    });
  }

  function renderConnections() {
    connections.innerHTML = '';
    state.nodes.forEach(node => {
      node.choices.forEach(choice => {
        const target = state.nodes.find(n => n.id === choice.successNode);
        if (!target) return;
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        const startX = node.x + 240;
        const startY = node.y + 120;
        const endX = target.x;
        const endY = target.y + 60;
        const midX = (startX + endX) / 2;
        path.setAttribute('d', `M ${startX} ${startY} C ${midX} ${startY}, ${midX} ${endY}, ${endX} ${endY}`);
        path.setAttribute('stroke', 'rgba(111, 157, 255, 0.8)');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('fill', 'none');
        connections.appendChild(path);
      });
    });
  }

  canvas.addEventListener('mousemove', (event) => {
    if (!state.drag) return;
    const node = state.nodes.find(n => n.id === state.drag.id);
    if (!node) return;
    node.x = event.offsetX - state.drag.offsetX;
    node.y = event.offsetY - state.drag.offsetY;
    render();
  });

  canvas.addEventListener('mouseup', () => {
    state.drag = null;
  });

  document.getElementById('addNodeBtn').onclick = () => createNode();
  document.getElementById('addChoiceBtn').onclick = () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (node) {
      addChoice(node);
    }
  };

  document.getElementById('exportBtn').onclick = () => {
    const payload = JSON.stringify(state.nodes, null, 2);
    navigator.clipboard.writeText(payload);
    alert('Экспортировано в буфер обмена.');
  };

  inspector.title.addEventListener('input', () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) return;
    node.title = inspector.title.value;
    render();
  });
  inspector.variants.addEventListener('input', () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) return;
    node.variants = inspector.variants.value;
    render();
  });
  inspector.terminal.addEventListener('change', () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) return;
    node.terminalType = inspector.terminal.value;
    render();
  });
  inspector.auto.addEventListener('input', () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) return;
    node.auto = inspector.auto.value;
  });
  inspector.reward.addEventListener('input', () => {
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node) return;
    node.reward = inspector.reward.value;
  });

  inspector.choices.addEventListener('input', (event) => {
    const target = event.target;
    const choiceId = target.getAttribute('data-choice-id');
    const field = target.getAttribute('data-field');
    const node = state.nodes.find(n => n.id === state.selectedNodeId);
    if (!node || !choiceId || !field) return;
    const choice = node.choices.find(c => c.id === choiceId);
    if (!choice) return;
    choice[field] = target.value;
    render();
  });

  createNode({
    title: 'Под пирсом Дель-Перро',
    variants: '"Ты просыпаешься под пирсом..."',
    terminalType: 'NONE',
    x: 160,
    y: 160,
    choices: [
      { id: 'C-start', label: 'Встать и осмотреться', successNode: '', failNode: '', effects: '[]' }
    ]
  });
  createNode({
    title: 'Утро на пляже',
    variants: '"Толпа на променаде"',
    terminalType: 'NONE',
    x: 520,
    y: 300,
  });
  state.nodes[0].choices[0].successNode = state.nodes[1].id;
  selectNode(state.nodes[0].id);
  render();
</script>
</body>
</html>
